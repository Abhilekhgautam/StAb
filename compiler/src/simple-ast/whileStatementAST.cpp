//
// Created by abhilekh on 5/23/24.
//

#include "./ast.h"

namespace STAB {
llvm::Value *STAB::WhileStatementAST::codegen(Scope *s) {
  llvm::Function *F = s->getFnBlock();
  if (!F) {
    std::cout << "\nnullptr encountered\n";
    return nullptr;
  }

  auto whileScope = new Scope(s, "loop");
  whileScope->setFnBlock(F);

  llvm::BasicBlock *loopBody =
      llvm::BasicBlock::Create(*TheContext, "loopBody", F);
  llvm::BasicBlock *afterLoop =
      llvm::BasicBlock::Create(*TheContext, "afterLoop", F);
  llvm::BasicBlock *checkCond =
      llvm::BasicBlock::Create(*TheContext, "checkCond", F);

  // Initial jump to condition check block
  Builder->CreateBr(checkCond);
  Builder->SetInsertPoint(checkCond);

  whileScope->setEntryBlock(loopBody);
  whileScope->setExitBlock(afterLoop);
  // Generate code for condition expression
  llvm::Value *cond = expr->codegen(s);

  // Compare the expr with 0 (loop continues if condition is non-zero)
  cond = Builder->CreateICmpNE(
      cond, llvm::ConstantInt::get(*TheContext, llvm::APInt(32, 0, true)));

  // Create conditional branch
  Builder->CreateCondBr(cond, loopBody, afterLoop);

  // Generate code for loop body
  Builder->SetInsertPoint(loopBody);
  for (const auto &elt : body) {
    if(whileScope->break_found()){
        Builder->SetInsertPoint(afterLoop);
        return F;
    }
    elt->codegen(whileScope);
  }

  // todo: repetive block fix this:
  if(whileScope->break_found()){
      Builder->SetInsertPoint(afterLoop);
      return F;
  }
  // After loop body, jump back to condition check
  Builder->CreateBr(checkCond);

  // Set insert point to afterLoop
  Builder->SetInsertPoint(afterLoop);

  return F;
}

} // namespace STAB
